package cc.slack.features.modules.impl.exploit.disablers.vulcan;

import cc.slack.events.impl.network.PacketEvent;
import cc.slack.events.impl.player.UpdateEvent;
import cc.slack.events.impl.player.WorldEvent;
import cc.slack.features.modules.impl.exploit.disablers.IDisabler;
import cc.slack.utils.client.mc;
import cc.slack.utils.network.PacketUtil;
import net.minecraft.network.Packet;
import net.minecraft.network.play.INetHandlerPlayServer;
import net.minecraft.network.play.client.C00PacketKeepAlive;
import net.minecraft.network.play.client.C0FPacketConfirmTransaction;

import java.util.LinkedList;
import java.util.Queue;

public class VulcanReachDisabler implements IDisabler {

    int ticks = 0;
    boolean shouldSend = false;

    Queue<Packet> packets = new LinkedList<>();

    @Override
    public void onDisable() {
        mc.getNetHandler().getNetworkManager().channel.writeAndFlush(packets);
        packets.clear();
    }

    public void onWorld(WorldEvent event) {
        packets.clear();
        ticks = 0;
    }

    @Override
    public void onUpdate(UpdateEvent event) {
        if (ticks <= 100) {
            ticks++;
        }
    }

    @Override
    public void onPacket(PacketEvent event) {
        final Packet packet = event.getPacket();
        if (ticks > 100) {
            if (mc.getPlayer().ticksExisted % 60 == 0) {
                if (mc.getCurrentScreen() == null) {
                    if (packet instanceof C00PacketKeepAlive || packet instanceof C0FPacketConfirmTransaction) {
                        event.cancel();
                        packets.add(packet);
                        shouldSend = true;
                    }
                } else {
                    packets.clear();
                }
            }
        }
        if (mc.getPlayer().ticksExisted % 20 == 0 && shouldSend) {
            mc.getNetHandler().getNetworkManager().channel.writeAndFlush(packets);
            shouldSend = false;
        }
    }

    @Override
    public String toString() {
        return "Vulcan Reach";
    }
}
